window.sendOrder = function(){
  const playerId = document.getElementById("playerId").value.trim();
  const receipt = document.getElementById("receipt").files[0];
  if(!playerId){alert("âš ï¸ Enter Player ID!"); return;}
  if(order.length===0){alert("âš ï¸ Select at least one package!"); return;}
  if(!receipt){alert("âš ï¸ Upload payment receipt!"); return;}

  const orderNumber = "ORD"+Date.now();
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  
  // Gradient header
  pdf.setFillColor(0, 123, 255);
  pdf.rect(0,0,210,25,'F');
  pdf.setFontSize(18);
  pdf.setTextColor(255,255,255);
  pdf.setFont("helvetica","bold");
  pdf.text("ğŸ’ FREE FIRE TOP-UP ORDER ğŸ’",105,16,{align:"center"});

  // Logo top-left
  const logo = new Image();
  logo.src = "https://files.catbox.moe/qhr7sl.jpg"; // store logo
  logo.onload = function(){
    pdf.addImage(logo,'JPEG',10,5,20,20);

    // Order details
    pdf.setFontSize(12);
    pdf.setTextColor(0,0,0);
    pdf.setFont("helvetica","normal");
    pdf.text(`Order No: ${orderNumber}`,10,35);
    pdf.text(`Player ID: ${playerId}`,10,42);
    pdf.text(`Total: ${(total-discount).toLocaleString()} LKR`,10,49);

    // Order table
    let y = 58;
    pdf.setDrawColor(0,123,255);
    pdf.setFillColor(0,123,255,0.1);
    pdf.rect(10,y-5,190,8,'F');
    pdf.text("Item",12,y);
    pdf.text("Qty",100,y);
    pdf.text("Subtotal",150,y);
    y+=6;
    order.forEach(o=>{
      pdf.text(o.name,12,y);
      pdf.text(String(o.qty),110,y);
      pdf.text(`${o.subTotal.toLocaleString()} LKR`,150,y);
      y+=8;
    });

    // Receipt image (if any)
    if(receipt.type.startsWith("image/")){
      const reader = new FileReader();
      reader.onload = e=>{
        pdf.addPage();
        pdf.setFontSize(14);
        pdf.setTextColor(0,123,255);
        pdf.text("ğŸ“ Payment Receipt",10,20);
        pdf.addImage(e.target.result,'JPEG',10,30,180,160);
        pdf.save(`Order_${orderNumber}.pdf`);
      };
      reader.readAsDataURL(receipt);
    } else {
      pdf.save(`Order_${orderNumber}.pdf`);
    }

    // WhatsApp message
    let orderText = order.map(o=>`${o.name} x${o.qty} = ${o.subTotal.toLocaleString()} LKR`).join("\n");
    const message = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ ğŸ’ FREE FIRE ORDER ğŸ’ â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Order No: ${orderNumber}
Player ID: ${playerId}
Order:
${orderText}
Total: ${(total-discount).toLocaleString()} LKR
Payment receipt attached
Link: ${window.location.href}
    `;
    const waUrl = "https://wa.me/94763208285?text=" + encodeURIComponent(message);
    window.open(waUrl,"_blank");
    document.getElementById("success").style.display="block";
  }
}